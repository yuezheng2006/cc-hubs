name: å†…å®¹æ›´æ–°å’Œéƒ¨ç½²

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©UTCæ—¶é—´02:00ï¼ˆåŒ—äº¬æ—¶é—´10:00ï¼‰æ‰§è¡Œ
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      crawl_ctok:
        description: 'çˆ¬å–ctok.aiå†…å®¹'
        required: false
        default: 'true'
        type: boolean
      crawl_cookbook:
        description: 'çˆ¬å–cookbookå†…å®¹'
        required: false
        default: 'true'
        type: boolean
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å†…å®¹'
        required: false
        default: 'false'
        type: boolean
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘ï¼ˆä»…é™æ–‡æ¡£ç›¸å…³æ–‡ä»¶ï¼‰
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'scripts/**'
      - 'mint.json'
      - '.github/workflows/**'

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

# ä½œä¸šå®šä¹‰
jobs:
  # å†…å®¹çˆ¬å–ä½œä¸š
  crawl-content:
    name: çˆ¬å–å’Œæ›´æ–°å†…å®¹
    runs-on: ubuntu-latest
    
    # æƒé™è®¾ç½®
    permissions:
      contents: write
      pull-requests: write
    
    # è¾“å‡ºå˜é‡
    outputs:
      content-updated: ${{ steps.check-changes.outputs.content-updated }}
      commit-sha: ${{ steps.commit-changes.outputs.commit-sha }}
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # è®¾ç½®pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # è·å–pnpmç¼“å­˜ç›®å½•
      - name: è·å–pnpmç¼“å­˜ç›®å½•
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      
      # ç¼“å­˜ä¾èµ–
      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      # åˆ›å»ºå¤‡ä»½
      - name: åˆ›å»ºå†…å®¹å¤‡ä»½
        run: |
          mkdir -p backups
          timestamp=$(date +"%Y%m%d_%H%M%S")
          cp -r docs "backups/docs_backup_${timestamp}"
          echo "BACKUP_TIMESTAMP=${timestamp}" >> $GITHUB_ENV
      
      # çˆ¬å–ctok.aiå†…å®¹
      - name: çˆ¬å–ctok.aiå†…å®¹
        if: github.event.inputs.crawl_ctok != 'false'
        run: |
          echo "ğŸ”„ å¼€å§‹çˆ¬å–ctok.aiå†…å®¹..."
          node scripts/crawlers/ctok-crawler.js
        env:
          FORCE_UPDATE: ${{ github.event.inputs.force_update }}
      
      # çˆ¬å–cookbookå†…å®¹
      - name: çˆ¬å–cookbookå†…å®¹
        if: github.event.inputs.crawl_cookbook != 'false'
        run: |
          echo "ğŸ”„ å¼€å§‹çˆ¬å–cookbookå†…å®¹..."
          node scripts/crawlers/cookbook-crawler.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update }}
      
      # å¤„ç†å’ŒéªŒè¯å†…å®¹
      - name: å¤„ç†å’ŒéªŒè¯å†…å®¹
        run: |
          echo "ğŸ“ å¤„ç†å’ŒéªŒè¯å†…å®¹..."
          node scripts/content-manager.js build --no-backup
      
      # æ£€æŸ¥å†…å®¹å˜æ›´
      - name: æ£€æŸ¥å†…å®¹å˜æ›´
        id: check-changes
        run: |
          if git diff --quiet HEAD -- docs/; then
            echo "content-updated=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹å˜æ›´"
          else
            echo "content-updated=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°å†…å®¹å˜æ›´"
            git diff --stat HEAD -- docs/
          fi
      
      # æäº¤å˜æ›´
      - name: æäº¤å†…å®¹å˜æ›´
        id: commit-changes
        if: steps.check-changes.outputs.content-updated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ·»åŠ å˜æ›´çš„æ–‡ä»¶
          git add docs/
          git add docs/_generated/ || true
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          commit_msg="ğŸ¤– è‡ªåŠ¨æ›´æ–°å†…å®¹ ($(date '+%Y-%m-%d %H:%M:%S'))"
          
          # æ·»åŠ è¯¦ç»†ä¿¡æ¯
          if [ "${{ github.event.inputs.crawl_ctok }}" != "false" ]; then
            commit_msg="${commit_msg}\n\n- æ›´æ–°ctok.aiå·¥ä½œæµç¨‹å†…å®¹"
          fi
          
          if [ "${{ github.event.inputs.crawl_cookbook }}" != "false" ]; then
            commit_msg="${commit_msg}\n- æ›´æ–°cookbookæœ€ä½³å®è·µå†…å®¹"
          fi
          
          # æäº¤å˜æ›´
          git commit -m "${commit_msg}"
          
          # æ¨é€å˜æ›´
          git push
          
          # è¾“å‡ºæäº¤SHA
          commit_sha=$(git rev-parse HEAD)
          echo "commit-sha=${commit_sha}" >> $GITHUB_OUTPUT
          echo "ğŸ“¤ å†…å®¹å˜æ›´å·²æäº¤: ${commit_sha}"
      
      # ä¸Šä¼ å¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœæœ‰å˜æ›´ï¼‰
      - name: ä¸Šä¼ å¤‡ä»½æ–‡ä»¶
        if: steps.check-changes.outputs.content-updated == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: content-backup-${{ env.BACKUP_TIMESTAMP }}
          path: backups/
          retention-days: 30
      
      # ä¸Šä¼ å¤„ç†æŠ¥å‘Š
      - name: ä¸Šä¼ å¤„ç†æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: processing-reports
          path: |
            docs/_generated/reports/
            docs/_generated/indexes/
          retention-days: 7

  # æ„å»ºå’Œéƒ¨ç½²ä½œä¸š
  build-and-deploy:
    name: æ„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: crawl-content
    if: needs.crawl-content.outputs.content-updated == 'true' || github.event_name == 'push'
    
    steps:
      # æ£€å‡ºä»£ç ï¼ˆä½¿ç”¨æœ€æ–°çš„æäº¤ï¼‰
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.crawl-content.outputs.commit-sha || github.sha }}
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # è®¾ç½®pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # ç¼“å­˜ä¾èµ–
      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      # æ„å»ºé¡¹ç›®
      - name: æ„å»ºé¡¹ç›®
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          pnpm run build
      
      # éƒ¨ç½²åˆ°Vercel
      - name: éƒ¨ç½²åˆ°Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

  # é€šçŸ¥ä½œä¸š
  notify:
    name: å‘é€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [crawl-content, build-and-deploy]
    if: always()
    
    steps:
      # å‘é€æˆåŠŸé€šçŸ¥
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: needs.build-and-deploy.result == 'success'
        run: |
          echo "âœ… å†…å®¹æ›´æ–°å’Œéƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“Š æ›´æ–°ç»Ÿè®¡:"
          echo "  - å†…å®¹å·²æ›´æ–°: ${{ needs.crawl-content.outputs.content-updated }}"
          echo "  - æäº¤SHA: ${{ needs.crawl-content.outputs.commit-sha }}"
          echo "  - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
      
      # å‘é€å¤±è´¥é€šçŸ¥
      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼"
          echo "ğŸ“‹ å¤±è´¥ä¿¡æ¯:"
          echo "  - çˆ¬å–ä½œä¸š: ${{ needs.crawl-content.result }}"
          echo "  - éƒ¨ç½²ä½œä¸š: ${{ needs.build-and-deploy.result }}"
          echo "  - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
      
      # åˆ›å»ºIssueï¼ˆå¦‚æœå¤±è´¥ï¼‰
      - name: åˆ›å»ºå¤±è´¥Issue
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const title = `ğŸš¨ è‡ªåŠ¨åŒ–å·¥ä½œæµå¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## å·¥ä½œæµæ‰§è¡Œå¤±è´¥
            
            **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
            **è¿è¡ŒID**: ${{ github.run_id }}
            **æäº¤SHA**: ${{ github.sha }}
            
            ### ä½œä¸šçŠ¶æ€
            - å†…å®¹çˆ¬å–: ${{ needs.crawl-content.result }}
            - æ„å»ºéƒ¨ç½²: ${{ needs.build-and-deploy.result }}
            
            ### å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ
            1. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œå¤–éƒ¨APIçŠ¶æ€
            2. éªŒè¯ç¯å¢ƒå˜é‡å’Œå¯†é’¥é…ç½®
            3. æŸ¥çœ‹è¯¦ç»†çš„å·¥ä½œæµæ—¥å¿—
            4. æ£€æŸ¥ä¾èµ–é¡¹æ˜¯å¦æœ‰æ›´æ–°
            
            **è‡ªåŠ¨ç”Ÿæˆäº**: ${new Date().toISOString()}
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automation', 'high-priority']
            });