name: æ‰‹åŠ¨éƒ¨ç½²

# ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
          - development
      skip_build:
        description: 'è·³è¿‡æ„å»ºæ­¥éª¤'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•æ­¥éª¤'
        required: false
        default: false
        type: boolean
      deploy_message:
        description: 'éƒ¨ç½²è¯´æ˜'
        required: false
        default: 'æ‰‹åŠ¨éƒ¨ç½²'
        type: string

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

# ä½œä¸šå®šä¹‰
jobs:
  # é¢„æ£€æŸ¥ä½œä¸š
  pre-check:
    name: éƒ¨ç½²å‰æ£€æŸ¥
    runs-on: ubuntu-latest
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      environment: ${{ github.event.inputs.environment }}
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # æ£€æŸ¥éƒ¨ç½²æ¡ä»¶
      - name: æ£€æŸ¥éƒ¨ç½²æ¡ä»¶
        id: check
        run: |
          echo "ğŸ” æ£€æŸ¥éƒ¨ç½²æ¡ä»¶..."
          
          # æ£€æŸ¥åˆ†æ”¯
          current_branch=$(git branch --show-current)
          echo "å½“å‰åˆ†æ”¯: $current_branch"
          
          # ç”Ÿäº§ç¯å¢ƒåªèƒ½ä»mainåˆ†æ”¯éƒ¨ç½²
          if [ "${{ github.event.inputs.environment }}" = "production" ] && [ "$current_branch" != "main" ]; then
            echo "âŒ ç”Ÿäº§ç¯å¢ƒåªèƒ½ä»mainåˆ†æ”¯éƒ¨ç½²"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
          if ! git diff --quiet; then
            echo "âš ï¸ æ£€æµ‹åˆ°æœªæäº¤çš„æ›´æ”¹"
          fi
          
          echo "âœ… éƒ¨ç½²å‰æ£€æŸ¥é€šè¿‡"
          echo "should-deploy=true" >> $GITHUB_OUTPUT
      
      # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯"
          echo "=================="
          echo "ç¯å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "åˆ†æ”¯: $(git branch --show-current)"
          echo "æäº¤: $(git rev-parse --short HEAD)"
          echo "è¯´æ˜: ${{ github.event.inputs.deploy_message }}"
          echo "è·³è¿‡æ„å»º: ${{ github.event.inputs.skip_build }}"
          echo "è·³è¿‡æµ‹è¯•: ${{ github.event.inputs.skip_tests }}"
          echo "=================="

  # æµ‹è¯•ä½œä¸š
  test:
    name: è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should-deploy == 'true' && github.event.inputs.skip_tests != 'true'
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # è®¾ç½®pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      # è¿è¡Œæµ‹è¯•
      - name: è¿è¡Œæµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          pnpm run test || {
            echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œéƒ¨ç½²å·²å–æ¶ˆ"
            exit 1
          }

  # æ„å»ºä½œä¸š
  build:
    name: æ„å»ºé¡¹ç›®
    runs-on: ubuntu-latest
    needs: [pre-check, test]
    if: always() && needs.pre-check.outputs.should-deploy == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped') && github.event.inputs.skip_build != 'true'
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # è®¾ç½®pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      # æ„å»ºé¡¹ç›®
      - name: æ„å»ºé¡¹ç›®
        run: |
          echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
          pnpm run build
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-${{ github.event.inputs.environment }}
          path: |
            dist/
            .next/
            out/
          retention-days: 7

  # éƒ¨ç½²ä½œä¸š
  deploy:
    name: éƒ¨ç½²åˆ° ${{ needs.pre-check.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [pre-check, test, build]
    if: always() && needs.pre-check.outputs.should-deploy == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.build.result == 'success' || needs.build.result == 'skipped')
    
    environment:
      name: ${{ needs.pre-check.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # è®¾ç½®pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # å®‰è£…ä¾èµ–ï¼ˆå¦‚æœè·³è¿‡äº†æ„å»ºï¼‰
      - name: å®‰è£…ä¾èµ–
        if: github.event.inputs.skip_build == 'true'
        run: pnpm install --frozen-lockfile
      
      # æ„å»ºé¡¹ç›®ï¼ˆå¦‚æœè·³è¿‡äº†æ„å»ºï¼‰
      - name: æ„å»ºé¡¹ç›®
        if: github.event.inputs.skip_build == 'true'
        run: pnpm run build
      
      # ä¸‹è½½æ„å»ºäº§ç‰©ï¼ˆå¦‚æœæ²¡æœ‰è·³è¿‡æ„å»ºï¼‰
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        if: github.event.inputs.skip_build != 'true'
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts-${{ github.event.inputs.environment }}
      
      # éƒ¨ç½²åˆ°Vercel
      - name: éƒ¨ç½²åˆ°Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ${{ github.event.inputs.environment == 'production' && '--prod' || '' }}
          working-directory: ./
      
      # è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      - name: è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼"
          echo "=================="
          echo "ç¯å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "URL: ${{ steps.deploy.outputs.preview-url }}"
          echo "è¯´æ˜: ${{ github.event.inputs.deploy_message }}"
          echo "æ—¶é—´: $(date)"
          echo "=================="

  # éƒ¨ç½²åéªŒè¯
  post-deploy:
    name: éƒ¨ç½²åéªŒè¯
    runs-on: ubuntu-latest
    needs: [deploy]
    if: needs.deploy.result == 'success'
    
    steps:
      # ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
      - name: ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
        run: |
          echo "â³ ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ..."
          sleep 30
      
      # å¥åº·æ£€æŸ¥
      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          
          # è·å–éƒ¨ç½²URLï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            url="https://claude-code-hub.vercel.app"
          else
            url="${{ needs.deploy.outputs.url }}"
          fi
          
          echo "æ£€æŸ¥URL: $url"
          
          # æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯è®¿é—®
          if curl -f -s "$url" > /dev/null; then
            echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
          else
            echo "âŒ ç½‘ç«™æ— æ³•è®¿é—®"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®é¡µé¢
          key_pages=("/" "/getting-started" "/workflows" "/commands" "/roles")
          
          for page in "${key_pages[@]}"; do
            if curl -f -s "${url}${page}" > /dev/null; then
              echo "âœ… é¡µé¢ ${page} å¯æ­£å¸¸è®¿é—®"
            else
              echo "âš ï¸ é¡µé¢ ${page} æ— æ³•è®¿é—®"
            fi
          done
      
      # æ€§èƒ½æ£€æŸ¥
      - name: æ€§èƒ½æ£€æŸ¥
        run: |
          echo "âš¡ æ‰§è¡Œæ€§èƒ½æ£€æŸ¥..."
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„æ€§èƒ½æ£€æŸ¥
          # ä¾‹å¦‚ä½¿ç”¨lighthouse-ciæˆ–å…¶ä»–å·¥å…·
          echo "â„¹ï¸ æ€§èƒ½æ£€æŸ¥åŠŸèƒ½å¾…å®ç°"

  # é€šçŸ¥ä½œä¸š
  notify:
    name: å‘é€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [pre-check, test, build, deploy, post-deploy]
    if: always()
    
    steps:
      # å‘é€æˆåŠŸé€šçŸ¥
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: needs.deploy.result == 'success' && needs.post-deploy.result == 'success'
        run: |
          echo "âœ… æ‰‹åŠ¨éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
          echo "  - ç¯å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "  - è¯´æ˜: ${{ github.event.inputs.deploy_message }}"
          echo "  - æµ‹è¯•: ${{ needs.test.result }}"
          echo "  - æ„å»º: ${{ needs.build.result }}"
          echo "  - éƒ¨ç½²: ${{ needs.deploy.result }}"
          echo "  - éªŒè¯: ${{ needs.post-deploy.result }}"
      
      # å‘é€å¤±è´¥é€šçŸ¥
      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: failure() || cancelled()
        run: |
          echo "âŒ æ‰‹åŠ¨éƒ¨ç½²å¤±è´¥ï¼"
          echo "ğŸ“‹ å¤±è´¥ä¿¡æ¯:"
          echo "  - é¢„æ£€æŸ¥: ${{ needs.pre-check.result }}"
          echo "  - æµ‹è¯•: ${{ needs.test.result }}"
          echo "  - æ„å»º: ${{ needs.build.result }}"
          echo "  - éƒ¨ç½²: ${{ needs.deploy.result }}"
          echo "  - éªŒè¯: ${{ needs.post-deploy.result }}"
          echo "  - ç¯å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "  - è¯´æ˜: ${{ github.event.inputs.deploy_message }}"