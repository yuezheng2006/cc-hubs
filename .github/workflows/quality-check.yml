name: ä»£ç è´¨é‡æ£€æŸ¥

# è§¦å‘æ¡ä»¶
on:
  # Pull Requestäº‹ä»¶
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  
  # æ¨é€åˆ°ä¸»è¦åˆ†æ”¯
  push:
    branches: [ main, develop ]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

# ä½œä¸šå®šä¹‰
jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # è®¾ç½®pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # ç¼“å­˜ä¾èµ–
      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      # ä»£ç æ ¼å¼æ£€æŸ¥
      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
          pnpm run format:check || {
            echo "âŒ ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥"
            echo "ğŸ’¡ è¯·è¿è¡Œ 'pnpm run format' ä¿®å¤æ ¼å¼é—®é¢˜"
            exit 1
          }
      
      # ESLintæ£€æŸ¥
      - name: ESLintæ£€æŸ¥
        run: |
          echo "ğŸ” è¿è¡ŒESLintæ£€æŸ¥..."
          pnpm run lint || {
            echo "âŒ ESLintæ£€æŸ¥å¤±è´¥"
            echo "ğŸ’¡ è¯·ä¿®å¤ä¸Šè¿°ä»£ç è´¨é‡é—®é¢˜"
            exit 1
          }
      
      # TypeScriptç±»å‹æ£€æŸ¥
      - name: TypeScriptç±»å‹æ£€æŸ¥
        run: |
          echo "ğŸ” è¿è¡ŒTypeScriptç±»å‹æ£€æŸ¥..."
          pnpm run type-check || {
            echo "âŒ TypeScriptç±»å‹æ£€æŸ¥å¤±è´¥"
            echo "ğŸ’¡ è¯·ä¿®å¤ä¸Šè¿°ç±»å‹é”™è¯¯"
            exit 1
          }
      
      # è¿è¡Œæµ‹è¯•
      - name: è¿è¡Œæµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          pnpm run test || {
            echo "âŒ æµ‹è¯•å¤±è´¥"
            exit 1
          }
      
      # æ„å»ºæ£€æŸ¥
      - name: æ„å»ºæ£€æŸ¥
        run: |
          echo "ğŸ”¨ æ£€æŸ¥æ„å»ºè¿‡ç¨‹..."
          pnpm run build || {
            echo "âŒ æ„å»ºå¤±è´¥"
            exit 1
          }
      
      # æ–‡æ¡£éªŒè¯
      - name: æ–‡æ¡£éªŒè¯
        run: |
          echo "ğŸ“‹ éªŒè¯æ–‡æ¡£è´¨é‡..."
          node scripts/content-manager.js validate || {
            echo "âš ï¸ æ–‡æ¡£éªŒè¯å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æŠ¥å‘Š"
            # ä¸è®©æ–‡æ¡£é—®é¢˜é˜»æ­¢æµç¨‹ï¼Œåªæ˜¯è­¦å‘Š
          }
      
      # ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: |
            coverage/
            test-results/
            docs/_generated/reports/
          retention-days: 7

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # è®¾ç½®pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      # ä¾èµ–å®‰å…¨æ‰«æ
      - name: ä¾èµ–å®‰å…¨æ‰«æ
        run: |
          echo "ğŸ”’ æ‰«æä¾èµ–å®‰å…¨æ¼æ´..."
          pnpm audit --audit-level moderate || {
            echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·åŠæ—¶æ›´æ–°ä¾èµ–"
            # ä¸é˜»æ­¢æµç¨‹ï¼Œä½†ä¼šåœ¨PRä¸­æ˜¾ç¤ºè­¦å‘Š
          }
      
      # CodeQLåˆ†æ
      - name: åˆå§‹åŒ–CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
      
      - name: æ‰§è¡ŒCodeQLåˆ†æ
        uses: github/codeql-action/analyze@v2

  # æ€§èƒ½æ£€æŸ¥
  performance-check:
    name: æ€§èƒ½æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # è®¾ç½®pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      # æ„å»ºé¡¹ç›®
      - name: æ„å»ºé¡¹ç›®
        run: pnpm run build
      
      # åˆ†ææ„å»ºäº§ç‰©å¤§å°
      - name: åˆ†ææ„å»ºäº§ç‰©å¤§å°
        run: |
          echo "ğŸ“Š åˆ†ææ„å»ºäº§ç‰©å¤§å°..."
          
          # æ£€æŸ¥æ„å»ºç›®å½•å¤§å°
          if [ -d "dist" ]; then
            build_size=$(du -sh dist | cut -f1)
            echo "ğŸ“¦ æ„å»ºäº§ç‰©æ€»å¤§å°: $build_size"
            
            # åˆ—å‡ºæœ€å¤§çš„æ–‡ä»¶
            echo "ğŸ“‹ æœ€å¤§çš„æ„å»ºæ–‡ä»¶:"
            find dist -type f -exec du -h {} + | sort -rh | head -10
          fi
          
          # æ£€æŸ¥node_moduleså¤§å°ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
          if [ -d "node_modules" ]; then
            deps_size=$(du -sh node_modules | cut -f1)
            echo "ğŸ“š ä¾èµ–å¤§å°: $deps_size"
          fi
      
      # è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          if [ -f "scripts/performance-test.js" ]; then
            echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
            node scripts/performance-test.js
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°æ€§èƒ½æµ‹è¯•è„šæœ¬"
          fi

  # PRè¯„è®º
  pr-comment:
    name: PRè¯„è®º
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, performance-check]
    if: github.event_name == 'pull_request'
    
    steps:
      # ç”Ÿæˆè´¨é‡æŠ¥å‘Šè¯„è®º
      - name: ç”Ÿæˆè´¨é‡æŠ¥å‘Šè¯„è®º
        uses: actions/github-script@v6
        with:
          script: |
            const qualityResult = '${{ needs.quality-check.result }}';
            const securityResult = '${{ needs.security-scan.result }}';
            const performanceResult = '${{ needs.performance-check.result }}';
            
            const getStatusEmoji = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¹ï¸';
                default: return 'âš ï¸';
              }
            };
            
            const comment = `
            ## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š
            
            | æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | ç»“æœ |
            |---------|------|------|
            | ä»£ç è´¨é‡æ£€æŸ¥ | ${getStatusEmoji(qualityResult)} | ${qualityResult} |
            | å®‰å…¨æ‰«æ | ${getStatusEmoji(securityResult)} | ${securityResult} |
            | æ€§èƒ½æ£€æŸ¥ | ${getStatusEmoji(performanceResult)} | ${performanceResult} |
            
            ### ğŸ“‹ æ£€æŸ¥è¯¦æƒ…
            
            ${qualityResult === 'success' ? 'âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡' : 'âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—'}
            ${securityResult === 'success' ? 'âœ… å®‰å…¨æ‰«æé€šè¿‡' : 'âš ï¸ å®‰å…¨æ‰«æå‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š'}
            ${performanceResult === 'success' ? 'âœ… æ€§èƒ½æ£€æŸ¥é€šè¿‡' : 'âš ï¸ æ€§èƒ½æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š'}
            
            ### ğŸ’¡ å»ºè®®
            
            - ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†åˆå¹¶
            - å…³æ³¨å®‰å…¨æ¼æ´å¹¶åŠæ—¶ä¿®å¤
            - ç›‘æ§æ„å»ºäº§ç‰©å¤§å°ï¼Œé¿å…è¿‡åº¦è†¨èƒ€
            - ä¿æŒä»£ç æ ¼å¼ä¸€è‡´æ€§
            
            ---
            *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
            `;
            
            // æŸ¥æ‰¾ç°æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š')
            );
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  # æ€»ç»“ä½œä¸š
  summary:
    name: æ£€æŸ¥æ€»ç»“
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, performance-check]
    if: always()
    
    steps:
      - name: è¾“å‡ºæ£€æŸ¥æ€»ç»“
        run: |
          echo "ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥æ€»ç»“"
          echo "========================"
          echo "ä»£ç è´¨é‡: ${{ needs.quality-check.result }}"
          echo "å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}"
          echo "æ€§èƒ½æ£€æŸ¥: ${{ needs.performance-check.result }}"
          echo "========================"
          
          # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡
          if [ "${{ needs.quality-check.result }}" = "success" ] && 
             [ "${{ needs.security-scan.result }}" = "success" ] && 
             [ "${{ needs.performance-check.result }}" = "success" ]; then
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
            exit 0
          else
            echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
            exit 1
          fi